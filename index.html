<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>M.J. Gross Inc. | Inventory App</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22 style=%22background-color:black;%22><text x=%2250%25%22 y=%2255%25%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22 font-family=%22serif%22 font-weight=%22bold%22 font-size=%2250%22 fill=%22white%22>MJG</text></svg>">
    
    <style>
        :root {
            --primary: #000000;
            --accent: #C5A059;
            --bg-gray: #f4f6f8;
            --border: #e2e8f0;
            --text-muted: #64748b;
            --white: #ffffff;
            --hover-row: #f8fafc;
        }
        
        * { box-sizing: border-box; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background-color: var(--bg-gray); color: #1e293b; font-size: 13px; overflow-x: hidden; }

        /* HEADER & DROP ZONE */
        header { background: var(--white); padding: 10px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 1000; }
        .logo-section { display: flex; align-items: center; gap: 15px; }
        .logo-img { height: 35px; }
        .header-controls { display: flex; gap: 15px; align-items: center; }

        .drop-zone { border: 2px dashed #cbd5e1; border-radius: 6px; padding: 6px 15px; display: flex; align-items: center; gap: 10px; background: #f8fafc; cursor: pointer; transition: 0.2s; }
        .drop-zone:hover, .drop-zone.dragover { background: #ecfdf5; border-color: #10b981; }
        .drop-text { font-size: 0.8rem; font-weight: 600; color: #475569; display: flex; flex-direction: column; line-height: 1.2; }
        #csv-input { display: none; }

        /* EMPTY STATE */
        .empty-state { display: flex; flex-direction: column; align-items: center; justify-content: center; height: calc(100vh - 60px); text-align: center; padding: 20px; }
        .giant-drop { border: 3px dashed #cbd5e1; border-radius: 12px; padding: 60px; background: var(--white); max-width: 600px; width: 100%; cursor: pointer; transition: 0.3s; box-shadow: 0 10px 30px rgba(0,0,0,0.05); }
        .giant-drop:hover, .giant-drop.dragover { border-color: var(--accent); background: #fffcf5; transform: translateY(-5px); }
        .giant-icon { font-size: 4rem; margin-bottom: 15px; }

        /* LAYOUT */
        .inventory-container { display: none; min-height: calc(100vh - 60px); }
        .sidebar { width: 340px; background: var(--white); border-right: 1px solid var(--border); padding: 20px; flex-shrink: 0; overflow-y: auto; height: calc(100vh - 60px); position: sticky; top: 60px; }
        
        .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .btn-reset { background: none; border: none; color: var(--accent); font-weight: bold; cursor: pointer; font-size: 0.8rem; text-transform: uppercase; padding: 0; }
        .btn-reset:hover { text-decoration: underline; }

        .filter-group { margin-bottom: 25px; border-bottom: 1px solid #f1f5f9; padding-bottom: 20px; }
        .filter-group:last-child { border-bottom: none; }
        .filter-label { font-weight: 800; display: block; margin-bottom: 12px; font-size: 0.7rem; letter-spacing: 1px; color: var(--text-muted); text-transform: uppercase; }
        
        /* FILTERS UI */
        .shape-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .btn-toggle { background: #fff; border: 1px solid #cbd5e1; padding: 8px 4px; font-size: 0.75rem; cursor: pointer; border-radius: 4px; transition: 0.1s; font-weight: 600; color: #475569; text-align: center; }
        .btn-toggle.active { background-color: var(--primary); color: #fff; border-color: var(--primary); }
        
        .carat-row { display: grid; gap: 6px; margin-bottom: 6px; }
        .row-3 { grid-template-columns: repeat(3, 1fr); }
        .row-4 { grid-template-columns: repeat(4, 1fr); }
        
        .touch-bar { display: flex; width: 100%; margin-bottom: 10px; flex-wrap: wrap; }
        .touch-btn { flex: 1 1 auto; padding: 8px 0; background: #fff; border: 1px solid #cbd5e1; margin-left: -1px; cursor: pointer; font-size: 0.7rem; font-weight: 600; color: #475569; text-align: center; min-width: 30px; }
        .touch-btn:first-child { border-top-left-radius: 4px; border-bottom-left-radius: 4px; margin-left: 0; }
        .touch-btn:last-child { border-top-right-radius: 4px; border-bottom-right-radius: 4px; }
        .touch-btn.active { background-color: var(--primary); color: #fff; border-color: var(--primary); z-index: 1; position: relative; }
        
        .range-row { display: flex; gap: 10px; align-items: center; margin-bottom: 8px; }
        .range-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.8rem; }

        /* TABLE (Desktop) - Adjusted for tight column widths */
        .results-area { flex-grow: 1; padding: 20px; overflow-x: auto; }
        .table-container { background: var(--white); border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); overflow: hidden; }
        
        /* Auto-sizing table strategy */
        table { width: max-content; min-width: 100%; border-collapse: collapse; }
        
        /* Tighter padding to meet the "+10 pixels" request (5px on each side) */
        th { background: #f8fafc; color: #475569; padding: 12px 5px; text-align: left; font-size: 0.7rem; text-transform: uppercase; font-weight: 700; border-bottom: 2px solid var(--border); cursor: pointer; user-select: none; white-space: nowrap; }
        th:hover { background: #e2e8f0; }
        td { padding: 10px 5px; border-bottom: 1px solid var(--border); font-size: 0.8rem; white-space: nowrap; vertical-align: middle; }
        
        /* Ensure the first spacer column stays small */
        th:first-child, td:first-child { padding-left: 10px; }
        th:last-child, td:last-child { padding-right: 15px; }

        .data-row { transition: background 0.15s; }
        .data-row:hover { background-color: var(--hover-row); }
        .col-expand { width: 30px; text-align: center; }
        .btn-expand { background: var(--white); border: 1px solid #cbd5e1; border-radius: 50%; width: 22px; height: 22px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--primary); transition: 0.2s; font-size: 1rem; padding: 0;}
        .btn-expand:hover { background: var(--primary); color: white; border-color: var(--primary); }
        .btn-expand.open { background: var(--accent); color: white; border-color: var(--accent); transform: rotate(45deg); }

        .lab-link { color: #2563eb; font-weight: 700; text-decoration: underline; cursor: pointer; }
        .lab-link:hover { color: #1d4ed8; }

        /* ENVELOPE ROW (Desktop Open Media) */
        .envelope-row { display: none; background: #f8fafc; box-shadow: inset 0 3px 6px rgba(0,0,0,0.03); }
        .envelope-row.show { display: table-row; }
        .env-showcase { display: flex; padding: 20px; gap: 20px; border-bottom: 2px solid var(--border); }
        .env-media-embed { width: 250px; height: 250px; border: 1px solid #cbd5e1; border-radius: 8px; overflow: hidden; background: #fff; display: flex; align-items: center; justify-content: center; position: relative; flex-shrink: 0; }
        .env-media-embed iframe, .env-media-embed img, .env-media-embed video { width: 100%; height: 100%; object-fit: contain; border: none; }
        .env-comments-box { flex-grow: 1; max-width: 500px; background: #fff; padding: 15px; border-radius: 8px; border: 1px solid #e2e8f0; }

        /* MOBILE SPECIFIC CSS */
        .mobile-only { display: none; }
        .desktop-only { display: table-cell; }

        @media (max-width: 1100px) {
            .desktop-only { display: none !important; }
            .mobile-only { display: block; }
            
            .inventory-container { flex-direction: column; }
            .sidebar { width: 100%; display: none; position: fixed; top: 0; bottom: 0; left: 0; right: 0; z-index: 2000; padding: 20px; padding-bottom: 100px; }
            .sidebar.show { display: block; }
            .results-area { padding: 10px; }
            
            .mobile-tools { display: flex; gap: 10px; background: var(--white); padding: 10px; border-bottom: 1px solid var(--border); position: sticky; top: 56px; z-index: 900; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
            .btn-mobile-tool { flex: 1; padding: 10px; border: 1px solid #cbd5e1; border-radius: 6px; background: var(--white); font-weight: 600; font-size: 0.85rem; display: flex; justify-content: space-between; align-items: center; }
            
            /* Table to Cards */
            table, tbody, tr { display: block; width: 100%; min-width: 100%; }
            thead { display: none; }
            .table-container { background: transparent; box-shadow: none; }
            
            .data-row { background: var(--white); border-radius: 10px; margin-bottom: 12px; padding: 15px; box-shadow: 0 2px 6px rgba(0,0,0,0.06); border: 1px solid #e2e8f0; position: relative; cursor: pointer; }
            .data-row td { padding: 0; border: none; display: none; } 
            td.mobile-only { display: block; } 
            
            .mobile-card { display: flex; flex-direction: column; gap: 8px; }
            .mc-line1 { font-size: 1.1rem; font-weight: 800; color: var(--primary); letter-spacing: -0.5px; margin-right: 80px; }
            .mc-line2 { font-size: 0.85rem; color: #475569; font-weight: 500; }
            .mc-line3 { font-size: 0.75rem; color: #64748b; background: #f1f5f9; padding: 6px 10px; border-radius: 4px; display: inline-block; font-family: monospace; }
            .mc-price { position: absolute; top: 15px; right: 15px; font-weight: 800; font-size: 1.1rem; color: #059669; }
            .mc-rap { position: absolute; bottom: 15px; right: 15px; font-size: 0.8rem; font-weight: 700; color: #dc2626; }
            
            /* Drawer */
            .drawer-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 3000; align-items: flex-end; }
            .drawer-overlay.open { display: flex; }
            .drawer-content { background: var(--white); width: 100%; height: 85vh; border-radius: 20px 20px 0 0; display: flex; flex-direction: column; animation: slideUp 0.3s ease-out; overflow: hidden; }
            .drawer-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: #f8fafc; }
            .drawer-body { overflow-y: auto; padding: 20px; flex-grow: 1; }
            @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
            
            .drop-text { display: none; }
            .drop-zone { padding: 8px; }
            .desktop-text { display: none; }
            .mobile-text { display: block; }
        }
        @media (min-width: 1101px) {
            .mobile-text { display: none; }
            .desktop-text { display: block; }
        }
    </style>
</head>
<body>

    <header>
        <div class="logo-section">
            <img src="images/logo.jpg" alt="MJG" class="logo-img" onerror="this.src='https://via.placeholder.com/100x35?text=MJG'">
            <span class="desktop-only" style="font-weight:700; color:#ccc;">|</span>
            <span class="desktop-only" style="font-size:0.9rem; font-weight:600; color:#333;">INVENTORY</span>
        </div>
        
        <div class="header-controls">
            <label for="csv-input" class="drop-zone" id="header-drop">
                <span style="font-size:1.2rem;">üìÇ</span>
                <span class="drop-text">Upload File<span style="font-size:0.7rem; font-weight:400;">Drag or tap CSV</span></span>
                <input type="file" id="csv-input" accept=".csv" onchange="handleFileUpload(this)">
            </label>
        </div>
    </header>

    <div class="empty-state" id="empty-state">
        <label for="csv-input-giant" class="giant-drop" id="main-drop">
            <div class="giant-icon">üì•</div>
            <div class="desktop-text">
                <h2 style="margin:0 0 10px 0;">Load Inventory Data</h2>
                <p style="color:#64748b; margin:0;">Drag and drop your CSV file here to begin.</p>
            </div>
            <div class="mobile-text">
                <h2 style="margin:0 0 10px 0;">Tap to Browse Files</h2>
                <p style="color:#64748b; margin:0;">Open your file manager to select your inventory CSV.</p>
            </div>
            <input type="file" id="csv-input-giant" accept=".csv" onchange="handleFileUpload(this)" style="display:none;">
        </label>
    </div>

    <div class="mobile-only mobile-tools" id="mobile-tools" style="display:none;">
        <button class="btn-mobile-tool" onclick="toggleSidebar()"><span><span id="mobile-count">(0)</span> Filters</span> <span>‚öôÔ∏è</span></button>
        <select class="btn-mobile-tool" onchange="mobileSort(this.value)" style="appearance:none; padding-right:30px;">
            <option value="">Sort By...</option>
            <option value="Size-asc">Size (Low to High)</option>
            <option value="Size-desc">Size (High to Low)</option>
            <option value="PriceTotal-asc">Price (Low to High)</option>
            <option value="PriceTotal-desc">Price (High to Low)</option>
            <option value="Rap Disc-asc">Rap Disc (Low to High)</option>
            <option value="Rap Disc-desc">Rap Disc (High to Low)</option>
        </select>
    </div>

    <div class="inventory-container" id="app-container">
        
        <aside class="sidebar" id="sidebar">
            <div class="mobile-only" style="text-align:right; margin-bottom:15px; font-size:1.5rem; cursor:pointer;" onclick="toggleSidebar()">‚úï</div>
            
            <div class="sidebar-header">
                <h3 style="margin:0; font-size:1.1rem;">Filters</h3>
                <button class="btn-reset" onclick="resetFilters()">Reset All</button>
            </div>
            
            <input type="text" id="search-box" placeholder="Search ID, Shape..." style="width:100%; padding:10px; border:1px solid #ccc; border-radius:4px; margin-bottom:20px;" onkeyup="runSearch()">

            <div class="filter-group">
                <span class="filter-label">SHAPE</span>
                <div class="shape-grid">
                    <button class="btn-toggle" onclick="toggleFilter('shape', 'Round', this)">Round</button>
                    <button class="btn-toggle" onclick="toggleFilter('shape', 'Oval', this)">Oval</button>
                    <button class="btn-toggle" onclick="toggleFilter('shape', 'Cushion', this)">Cushion</button>
                    <button class="btn-toggle" onclick="toggleFilter('shape', 'Emerald', this)">Emerald</button>
                    <button class="btn-toggle" onclick="toggleFilter('shape', 'Pear', this)">Pear</button>
                    <button class="btn-toggle" onclick="toggleFilter('shape', 'Radiant', this)">Radiant</button>
                    <button class="btn-toggle" onclick="toggleFilter('shape', 'Princess', this)">Princess</button>
                    <button class="btn-toggle" onclick="toggleFilter('shape', 'Asscher', this)">Asscher</button>
                    <button class="btn-toggle" onclick="toggleFilter('shape', 'Marquise', this)">Marquise</button>
                </div>
            </div>

            <div class="filter-group">
                <span class="filter-label">SIZE (CARAT)</span>
                <div class="carat-row row-3">
                    <button class="btn-toggle" onclick="toggleCarat(0.30, 0.99, this)">0.30-0.99</button>
                    <button class="btn-toggle" onclick="toggleCarat(1.00, 1.49, this)">1.00-1.49</button>
                    <button class="btn-toggle" onclick="toggleCarat(1.50, 1.99, this)">1.50-1.99</button>
                </div>
                <div class="carat-row row-4">
                    <button class="btn-toggle" onclick="toggleCarat(2.00, 2.99, this)">2.00-2.99</button>
                    <button class="btn-toggle" onclick="toggleCarat(3.00, 3.99, this)">3.00-3.99</button>
                    <button class="btn-toggle" onclick="toggleCarat(4.00, 4.99, this)">4.00-4.99</button>
                    <button class="btn-toggle" onclick="toggleCarat(5.00, 99.9, this)">5.00+</button>
                </div>
                <div class="range-row">
                    <input type="number" id="min-size" class="range-input" placeholder="Min Size" step="0.01" oninput="runSearch()">
                    <input type="number" id="max-size" class="range-input" placeholder="Max Size" step="0.01" oninput="runSearch()">
                </div>
            </div>

            <div class="filter-group">
                <span class="filter-label">COLOR</span>
                <div class="touch-bar" id="color-bar"></div>
                <span class="filter-label" style="margin-top:15px;">CLARITY</span>
                <div class="touch-bar" id="clarity-bar"></div>
            </div>

            <div class="filter-group">
                <span class="filter-label">LAB</span>
                <div class="touch-bar" id="lab-bar"></div>
            </div>

            <div class="filter-group">
                <span class="filter-label">CUT</span>
                <div class="touch-bar" id="cut-bar"></div>
                <span class="filter-label">POLISH</span>
                <div class="touch-bar" id="pol-bar"></div>
                <span class="filter-label">SYMMETRY</span>
                <div class="touch-bar" id="sym-bar"></div>
                <span class="filter-label">FLUORESCENCE</span>
                <div class="touch-bar" id="fluo-bar"></div>
            </div>

            <div class="filter-group">
                <span class="filter-label">DEPTH %</span>
                <div class="range-row">
                    <input type="number" id="depth-min" class="range-input" placeholder="Min" oninput="runSearch()">
                    <input type="number" id="depth-max" class="range-input" placeholder="Max" oninput="runSearch()">
                </div>
                <span class="filter-label" style="margin-top:10px;">TABLE %</span>
                <div class="range-row">
                    <input type="number" id="table-min" class="range-input" placeholder="Min" oninput="runSearch()">
                    <input type="number" id="table-max" class="range-input" placeholder="Max" oninput="runSearch()">
                </div>
                <span class="filter-label" style="margin-top:10px;">RATIO</span>
                <div class="range-row">
                    <input type="number" id="ratio-min" class="range-input" placeholder="Min" step="0.01" oninput="runSearch()">
                    <input type="number" id="ratio-max" class="range-input" placeholder="Max" step="0.01" oninput="runSearch()">
                </div>
            </div>

            <button onclick="toggleSidebar()" class="mobile-only" style="width:100%; padding:15px; background:var(--primary); color:white; border:none; border-radius:4px; font-weight:bold; position:sticky; bottom:0;">APPLY FILTERS</button>
        </aside>

        <main class="results-area">
            <div class="table-container">
                <table id="inventory-table">
                    <thead>
                        <tr class="desktop-only">
                            <th style="width:30px;"></th>
                            <th onclick="sortBy('ID')">ID <span id="sort-ID"></span></th>
                            <th onclick="sortBy('Shape')">Shape <span id="sort-Shape"></span></th>
                            <th onclick="sortBy('Size')">Size <span id="sort-Size"></span></th>
                            <th onclick="sortBy('Color')">Col <span id="sort-Color"></span></th>
                            <th onclick="sortBy('Clarity')">Clar <span id="sort-Clarity"></span></th>
                            <th onclick="sortBy('Measurements')">Meas <span id="sort-Measurements"></span></th>
                            <th onclick="sortBy('Ratio')">Ratio <span id="sort-Ratio"></span></th>
                            <th onclick="sortBy('Lab')">Lab <span id="sort-Lab"></span></th>
                            <th onclick="sortBy('Cut')">Cut <span id="sort-Cut"></span></th>
                            <th onclick="sortBy('Pol')">Pol <span id="sort-Pol"></span></th>
                            <th onclick="sortBy('Sym')">Sym <span id="sort-Sym"></span></th>
                            <th onclick="sortBy('Fluo')">Flor <span id="sort-Fluo"></span></th>
                            <th onclick="sortBy('Depth')">Dep% <span id="sort-Depth"></span></th>
                            <th onclick="sortBy('Table')">Tab% <span id="sort-Table"></span></th>
                            <th onclick="sortBy('Culet')">Cul <span id="sort-Culet"></span></th>
                            <th onclick="sortBy('Girdle')">Grd <span id="sort-Girdle"></span></th>
                            <th onclick="sortBy('PriceRap')">Rap $ <span id="sort-PriceRap"></span></th>
                            <th onclick="sortBy('Rap Disc')">Rap% <span id="sort-Rap Disc"></span></th>
                            <th onclick="sortBy('PriceTotal')">Total $ <span id="sort-PriceTotal"></span></th>
                        </tr>
                    </thead>
                    <tbody id="table-body">
                        </tbody>
                </table>
            </div>
        </main>
    </div>

    <div class="drawer-overlay" id="mobile-drawer">
        <div class="drawer-content">
            <div class="drawer-header">
                <div id="drawer-title" style="font-size:1.2rem; font-weight:800; color:var(--primary);"></div>
                <button onclick="closeDrawer()" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">‚úï</button>
            </div>
            <div class="drawer-body" id="drawer-body">
                </div>
        </div>
    </div>

    <script>
        // --- 1. CONFIG & STATE ---
        let inventoryData = [];
        let filteredData = [];
        let sortCol = '';
        let sortDir = 1; 
        
        let activeFilters = {
            shape: [], caratRanges: [], color: [], clarity: [], lab: [], cut: [], pol: [], sym: [], fluo: []
        };

        const config = {
            colors: ['D','E','F','G','H','I','J','K','L','M'],
            clarities: ['FL','IF','VVS1','VVS2','VS1','VS2','SI1','SI2','I1'],
            labs: ['GIA','IGI','HRD'],
            grades: ['EX','VG','GD','FR','F'],
            fluos: ['NON','FNT','MED','STG','VST']
        };

        // --- 2. DRAG & DROP / FILE MANAGER ---
        ['header-drop', 'main-drop', 'empty-state'].forEach(id => {
            const el = document.getElementById(id);
            if(!el) return;
            el.addEventListener('dragover', e => { e.preventDefault(); el.classList.add('dragover'); });
            el.addEventListener('dragleave', e => { el.classList.remove('dragover'); });
            el.addEventListener('drop', e => {
                e.preventDefault(); el.classList.remove('dragover');
                if(e.dataTransfer.files.length) handleFiles(e.dataTransfer.files[0]);
            });
        });

        function handleFileUpload(input) { if(input.files.length) handleFiles(input.files[0]); }

        function handleFiles(file) {
            const reader = new FileReader();
            reader.onload = e => parseCSV(e.target.result);
            reader.readAsText(file);
        }

        // --- 3. ROBUST CSV PARSER ---
        function parseCSV(text) {
            let p = '', row = [''], ret = [row], i = 0, r = 0, s = !0, l;
            for (l of text) {
                if ('"' === l) {
                    if (s && l === p) row[i] += l;
                    s = !s;
                } else if (',' === l && s) l = row[++i] = '';
                else if ('\n' === l && s) {
                    if ('\r' === p) row[i] = row[i].slice(0, -1);
                    row = ret[++r] = [l = '']; i = 0;
                } else row[i] += l;
                p = l;
            }
            
            const rawHeaders = ret[0].map(h => h.replace(/^[\u200B\u200C\u200D\u200E\u200F\uFEFF]/,"").trim());
            const data = [];
            for (let j = 1; j < ret.length; j++) {
                if (ret[j].length < 2 || ret[j].join('').trim() === '') continue; 
                let obj = {};
                rawHeaders.forEach((h, index) => {
                    obj[h.toLowerCase()] = ret[j][index] ? ret[j][index].trim() : '';
                });
                data.push(obj);
            }

            inventoryData = data;
            document.getElementById('empty-state').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            if(window.innerWidth <= 1100) document.getElementById('mobile-tools').style.display = 'flex';
            
            runSearch();
        }

        // Safe getter with fallback matching (Fixes the "link" missing bug)
        function getRobustVal(row, possibleKeys) {
            for (let k of possibleKeys) {
                let lowerK = k.toLowerCase().replace(/[^a-z0-9]/g, '');
                let found = Object.keys(row).find(rk => rk.replace(/[^a-z0-9]/g, '') === lowerK);
                if (found && row[found] && row[found].trim() !== '') return row[found].trim();
            }
            return '';
        }

        function getVal(row, exactHeader) { 
            return row[exactHeader.toLowerCase()] || ''; 
        }

        // --- 4. UI BUILDERS ---
        function initTouchBar(id, items, filterKey) {
            const container = document.getElementById(id);
            container.innerHTML = '';
            items.forEach((item, index) => {
                const btn = document.createElement('div');
                btn.className = 'touch-btn';
                btn.innerText = item;
                btn.onclick = () => handleRangeClick(index, items, filterKey, id);
                container.appendChild(btn);
            });
        }

        initTouchBar('color-bar', config.colors, 'color');
        initTouchBar('clarity-bar', config.clarities, 'clarity');
        initTouchBar('lab-bar', config.labs, 'lab');
        initTouchBar('cut-bar', config.grades, 'cut');
        initTouchBar('pol-bar', config.grades, 'pol');
        initTouchBar('sym-bar', config.grades, 'sym');
        initTouchBar('fluo-bar', config.fluos, 'fluo');

        // --- 5. FILTER LOGIC (SMART TOGGLE FIX) ---
        function handleRangeClick(index, items, key, domId) {
            let active = activeFilters[key];
            const clickedItem = items[index];
            
            if (active.length === 1 && active[0] === clickedItem) {
                activeFilters[key] = []; 
            } else if (active.includes(clickedItem)) {
                activeFilters[key] = [clickedItem]; 
            } else if (active.length === 0) {
                activeFilters[key] = [clickedItem]; 
            } else {
                const activeIndices = active.map(val => items.indexOf(val));
                const min = Math.min(...activeIndices, index);
                const max = Math.max(...activeIndices, index);
                activeFilters[key] = [];
                for(let i=min; i<=max; i++) activeFilters[key].push(items[i]);
            }
            
            updateTouchUI(domId, items, activeFilters[key]);
            runSearch();
        }

        function updateTouchUI(domId, items, activeArr) {
            const btns = document.getElementById(domId).children;
            for(let i=0; i<btns.length; i++) {
                btns[i].classList.toggle('active', activeArr.includes(items[i]));
            }
        }

        function toggleFilter(key, val, btn) {
            btn.classList.toggle('active');
            const arr = activeFilters[key];
            arr.includes(val) ? arr.splice(arr.indexOf(val), 1) : arr.push(val);
            runSearch();
        }

        function toggleCarat(min, max, btn) {
            btn.classList.toggle('active');
            const ranges = activeFilters.caratRanges;
            const idx = ranges.findIndex(r => r.min === min && r.max === max);
            if(idx > -1) ranges.splice(idx, 1);
            else ranges.push({min, max});
            document.getElementById('min-size').value = '';
            document.getElementById('max-size').value = '';
            runSearch();
        }

        function resetFilters() {
            activeFilters = { shape: [], caratRanges: [], color: [], clarity: [], lab: [], cut: [], pol: [], sym: [], fluo: [] };
            document.getElementById('search-box').value = '';
            document.querySelectorAll('.range-input').forEach(input => input.value = '');
            document.querySelectorAll('.btn-toggle').forEach(btn => btn.classList.remove('active'));
            ['color-bar', 'clarity-bar', 'lab-bar', 'cut-bar', 'pol-bar', 'sym-bar', 'fluo-bar'].forEach(id => {
                Array.from(document.getElementById(id).children).forEach(btn => btn.classList.remove('active'));
            });
            runSearch();
        }

        // --- 6. SEARCH & SORT ---
        function sortBy(col) {
            if (sortCol === col) sortDir *= -1;
            else { sortCol = col; sortDir = 1; }
            document.querySelectorAll('th span').forEach(sp => sp.innerText = '');
            const sp = document.getElementById('sort-' + col);
            if(sp) sp.innerText = sortDir === 1 ? ' ‚Üë' : ' ‚Üì';
            runSearch();
        }

        function mobileSort(val) {
            if(!val) return;
            const parts = val.split('-');
            sortCol = parts[0]; sortDir = parts[1] === 'asc' ? 1 : -1;
            runSearch();
        }

        function getNum(id) { return parseFloat(document.getElementById(id).value); }

        function runSearch() {
            const query = (document.getElementById('search-box')?.value || '').toLowerCase();
            const minS = getNum('min-size'), maxS = getNum('max-size');
            const minD = getNum('depth-min'), maxD = getNum('depth-max');
            const minT = getNum('table-min'), maxT = getNum('table-max');
            const minR = getNum('ratio-min'), maxR = getNum('ratio-max');

            filteredData = inventoryData.filter(row => {
                if(query) {
                    const searchable = (getVal(row,'ID') + getVal(row,'Shape')).toLowerCase();
                    if(!searchable.includes(query)) return false;
                }

                const checkArr = (key, csvHeader) => {
                    if(!activeFilters[key].length) return true;
                    const val = getVal(row, csvHeader).toUpperCase();
                    
                    // Fixed Shape Matching (Round vs Radiant bug fix)
                    if (key === 'shape' || key === 'lab' || key === 'cut' || key === 'pol' || key === 'sym' || key === 'color' || key === 'clarity') {
                        return activeFilters[key].some(f => val === f.toUpperCase() || val.includes(f.toUpperCase()));
                    }
                    // Fluor handles 'Faint' vs 'FNT' via charAt
                    return activeFilters[key].some(f => val.includes(f) || val.startsWith(f.charAt(0)));
                };

                if(!checkArr('shape', 'Shape')) return false;
                if(!checkArr('color', 'Color')) return false;
                if(!checkArr('clarity', 'Clarity')) return false;
                if(!checkArr('lab', 'Lab')) return false;
                if(!checkArr('cut', 'Cut')) return false;
                if(!checkArr('pol', 'Pol')) return false;
                if(!checkArr('sym', 'Sym')) return false;
                if(!checkArr('fluo', 'Fluo')) return false;

                const size = parseFloat(getVal(row, 'Size'));
                let sMatch = false;
                if (!isNaN(minS) || !isNaN(maxS)) {
                    sMatch = (isNaN(minS) || size >= minS) && (isNaN(maxS) || size <= maxS);
                } else if (activeFilters.caratRanges.length) {
                    sMatch = activeFilters.caratRanges.some(r => size >= r.min && size <= r.max);
                } else sMatch = true;
                if (!sMatch) return false;

                const checkNum = (val, min, max) => {
                    const n = parseFloat(val);
                    if(isNaN(n)) return true; 
                    if(!isNaN(min) && n < min) return false;
                    if(!isNaN(max) && n > max) return false;
                    return true;
                };

                if(!checkNum(getVal(row,'Depth'), minD, maxD)) return false;
                if(!checkNum(getVal(row,'Table'), minT, maxT)) return false;
                if(!checkNum(getVal(row,'Ratio'), minR, maxR)) return false;

                return true;
            });

            if (sortCol) {
                filteredData.sort((a, b) => {
                    let valA = getVal(a, sortCol);
                    let valB = getVal(b, sortCol);
                    const numA = parseFloat(valA.replace(/[^0-9.-]+/g,""));
                    const numB = parseFloat(valB.replace(/[^0-9.-]+/g,""));
                    if (!isNaN(numA) && !isNaN(numB)) return (numA - numB) * sortDir;
                    return valA.toString().localeCompare(valB.toString()) * sortDir;
                });
            }

            renderTable();
        }

        // --- 7. RENDER DESKTOP & MOBILE ---
        function renderTable() {
            const tbody = document.getElementById('table-body');
            document.getElementById('mobile-count').innerText = `(${filteredData.length})`;
            tbody.innerHTML = '';

            filteredData.forEach((row, i) => {
                const tr = document.createElement('tr');
                tr.className = 'data-row';
                
                const formatMoney = v => { const n = parseFloat(v); return isNaN(n) ? '' : '$' + n.toLocaleString(); };
                const formatNum = v => { const n = parseFloat(v); return isNaN(n) ? '' : n.toFixed(2); };
                const formatUrl = u => u.startsWith('http') ? u : `https://${u}`;

                // Robust link fetching to ignore spaces/brackets in headers
                const photo = getRobustVal(row, ['Photo', 'Photo(link)', 'Photo (link)', 'Image']);
                const video = getRobustVal(row, ['Video', 'Video(link)', 'Video (link)']);
                const report = getRobustVal(row, ['ReportPDF', 'ReportPDF(link)', 'ReportPDF (link)', 'Cert', 'Report']);

                const labStr = getVal(row,'Lab') || 'CERT';
                let labHtml = labStr;
                if(report) {
                    labHtml = `<a href="${formatUrl(report)}" target="_blank" class="lab-link" onclick="event.stopPropagation();">${labStr}</a>`;
                }

                // A. DESKTOP ROW 
                tr.innerHTML = `
                    <td class="col-expand desktop-only"><button class="btn-expand" onclick="toggleEnvelope(this, ${i})">+</button></td>
                    <td class="desktop-only">${getVal(row,'ID')}</td>
                    <td class="desktop-only"><b>${getVal(row,'Shape')}</b></td>
                    <td class="desktop-only">${formatNum(getVal(row,'Size'))}</td>
                    <td class="desktop-only">${getVal(row,'Color')}</td>
                    <td class="desktop-only">${getVal(row,'Clarity')}</td>
                    <td class="desktop-only">${getVal(row,'Measurements')}</td>
                    <td class="desktop-only">${getVal(row,'Ratio')}</td>
                    <td class="desktop-only">${labHtml}</td>
                    <td class="desktop-only">${getVal(row,'Cut')}</td>
                    <td class="desktop-only">${getVal(row,'Pol')}</td>
                    <td class="desktop-only">${getVal(row,'Sym')}</td>
                    <td class="desktop-only">${getVal(row,'Fluo')}</td>
                    <td class="desktop-only">${getVal(row,'Depth')}%</td>
                    <td class="desktop-only">${getVal(row,'Table')}%</td>
                    <td class="desktop-only">${getVal(row,'Culet')}</td>
                    <td class="desktop-only">${getVal(row,'Girdle')}</td>
                    <td class="desktop-only">${formatMoney(getVal(row,'PriceRap'))}</td>
                    <td class="desktop-only" style="color:#dc2626; font-weight:600;">${getVal(row,'Rap Disc')}%</td>
                    <td class="desktop-only" style="color:#059669; font-weight:bold;">${formatMoney(getVal(row,'PriceTotal'))}</td>
                    
                    <td class="mobile-only" onclick="openDrawer(${i})">
                        <div class="mobile-card">
                            <div class="mc-price">${formatMoney(getVal(row,'PriceTotal'))}</div>
                            <div class="mc-rap">${getVal(row,'Rap Disc')}%</div>
                            <div class="mc-line1">${getVal(row,'Shape')} ${formatNum(getVal(row,'Size'))} ${getVal(row,'Color')} ${getVal(row,'Clarity')} ${getVal(row,'Lab')}</div>
                            <div class="mc-line2">${getVal(row,'Measurements')} ‚Ä¢ Ratio: ${getVal(row,'Ratio')}</div>
                            <div class="mc-line3">D:${getVal(row,'Depth')} T:${getVal(row,'Table')} P:${getVal(row,'Pol')} S:${getVal(row,'Sym')} F:${getVal(row,'Fluo')}</div>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);

                // C. DESKTOP ENVELOPE (Embedded Media)
                const env = document.createElement('tr');
                env.className = 'envelope-row desktop-only';
                env.id = `env-${i}`;
                
                const photoEmbed = photo ? `<img src="${formatUrl(photo)}" onerror="this.style.display='none'">` : '';
                
                let videoEmbed = '';
                if (video) {
                    if (video.toLowerCase().endsWith('.mp4')) {
                        videoEmbed = `<video src="${formatUrl(video)}" controls autoplay loop muted></video>`;
                    } else {
                        videoEmbed = `<iframe src="${formatUrl(video)}" allowfullscreen></iframe>`;
                    }
                }

                env.innerHTML = `
                    <td colspan="20" style="padding:0;">
                        <div class="env-showcase">
                            ${photoEmbed ? `<div class="env-media-embed">${photoEmbed}</div>` : ''}
                            ${videoEmbed ? `<div class="env-media-embed">${videoEmbed}</div>` : ''}
                            <div class="env-comments-box">
                                <h4 style="margin:0 0 10px 0; color:#475569; border-bottom:1px solid #e2e8f0; padding-bottom:5px;">Comments & Notes</h4>
                                <p style="margin:0; font-size:0.9rem; line-height:1.6;">${getVal(row,'Comments') || 'No additional comments provided.'}</p>
                            </div>
                        </div>
                    </td>
                `;
                tbody.appendChild(env);
            });
        }

        // --- 8. INTERACTIONS ---
        function toggleEnvelope(btn, index) {
            const env = document.getElementById(`env-${index}`);
            const isOpen = env.classList.contains('show');
            document.querySelectorAll('.envelope-row.show').forEach(e => e.classList.remove('show'));
            document.querySelectorAll('.btn-expand.open').forEach(b => b.classList.remove('open'));
            if (!isOpen) { env.classList.add('show'); btn.classList.add('open'); }
        }

        function openDrawer(index) {
            const row = filteredData[index];
            document.getElementById('mobile-drawer').classList.add('open');
            document.getElementById('drawer-title').innerText = `${getVal(row,'Shape')} ${getVal(row,'Size')}ct ${getVal(row,'Color')} ${getVal(row,'Clarity')}`;
            
            const photo = getRobustVal(row, ['Photo', 'Photo(link)', 'Photo (link)', 'Image']);
            const video = getRobustVal(row, ['Video', 'Video(link)', 'Video (link)']);
            const report = getRobustVal(row, ['ReportPDF', 'ReportPDF(link)', 'ReportPDF (link)', 'Cert', 'Report']);

            const linkBtn = (link, label, icon) => {
                if(!link || link.trim() === '') return '';
                const url = link.startsWith('http') ? link : `https://${link}`;
                return `<a href="${url}" target="_blank" style="flex:1; padding:15px; background:#f8fafc; border:1px solid #e2e8f0; border-radius:8px; text-align:center; font-weight:bold; color:var(--primary); text-decoration:none; display:flex; flex-direction:column; gap:5px;"><span style="font-size:1.5rem;">${icon}</span>${label}</a>`;
            };

            const formatMoney = v => { const n = parseFloat(v); return isNaN(n) ? '' : '$' + n.toLocaleString(); };

            document.getElementById('drawer-body').innerHTML = `
                <div style="font-size:2rem; font-weight:800; color:#059669; margin-bottom:5px;">${formatMoney(getVal(row,'PriceTotal'))}</div>
                <div style="font-size:1rem; color:#dc2626; font-weight:700; margin-bottom:20px;">Rap Disc: ${getVal(row,'Rap Disc')}% ‚Ä¢ ID: ${getVal(row,'ID')}</div>
                
                <div style="display:flex; gap:10px; margin-bottom:25px;">
                    ${linkBtn(photo, 'Photo', 'üì∑')}
                    ${linkBtn(video, 'Video', 'üé•')}
                    ${linkBtn(report, 'Cert', 'üìÑ')}
                </div>

                <div style="background:#f1f5f9; padding:15px; border-radius:8px; margin-bottom:20px;">
                    <div style="font-weight:700; margin-bottom:5px; color:#475569;">Comments</div>
                    <div style="font-size:0.9rem;">${getVal(row,'Comments') || 'No comments.'}</div>
                </div>

                <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px;">
                    <div><span style="font-size:0.75rem; color:#64748b; font-weight:bold;">MEASUREMENTS</span><br><b>${getVal(row,'Measurements')||'-'}</b></div>
                    <div><span style="font-size:0.75rem; color:#64748b; font-weight:bold;">RATIO</span><br><b>${getVal(row,'Ratio')||'-'}</b></div>
                    <div><span style="font-size:0.75rem; color:#64748b; font-weight:bold;">DEPTH / TABLE</span><br><b>${getVal(row,'Depth')||'-'}% / ${getVal(row,'Table')||'-'}%</b></div>
                    <div><span style="font-size:0.75rem; color:#64748b; font-weight:bold;">CULET / GIRDLE</span><br><b>${getVal(row,'Culet')||'-'} / ${getVal(row,'Girdle')||'-'}</b></div>
                </div>
            `;
        }

        function closeDrawer() { document.getElementById('mobile-drawer').classList.remove('open'); }
        function toggleSidebar() { document.getElementById('sidebar').classList.toggle('show'); }
    </script>
</body>
</html>
